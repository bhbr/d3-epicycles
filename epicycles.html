<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <script src="d3.v4.min.js"></script>
    <style>
        body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
    </style>
</head>

<body>
    <button onclick="togglePlay();">Play/Pause</button>
    <script>
        var TAU = 6.283;
        
        var svg_width = 600;
        var svg_height = 600;
        
        var body = d3.select("body");
        var svg = body.append("svg")
            .attr("width", svg_width)
            .attr("height",svg_height);


        var nb_bodies = 5;
        var body_radii = [30, 20, 15, 10, 5];
        var body_colors = ['yellow', 'green', 'red', 'blue', 'cyan'];
        var orbital_radii = [0, 100, 75, 50, 20];
        var orbital_phases = [0*TAU, 0.3*TAU, -0.2*TAU,0.45*TAU, 0.75*TAU];
        var orbital_periods = [6000, 3000, 2000, 1500, 1200];

        var data = [];
        var cx = svg_width/2;
        var cy = svg_height/2;
        for (var i = 0; i < nb_bodies; i++) {
            data.push({
                'cx': cx,
                'cy': cy,
                'body_radius': body_radii[i],
                'body_color': body_colors[i],
            })
            cx += orbital_radii[i+1] * Math.cos(orbital_phases[i+1]);
            cy += orbital_radii[i+1] * Math.sin(orbital_phases[i+1]);
        }

        heavenly_bodies = [];
        svg.data(data)
            .enter()
            .append("circle")
            .attr("cx", d => d['cx'])
            .attr("cy", d => d['cy'])
            .attr("r", d => d['body_radius'])
            .attr("fill", d => d['body_color'])
            .attr("stroke", "black");
        heavenly_bodies.push(new_body);
        

    var orbits = [];
    for (var i = 0; i < nb_bodies; i++) {
        var new_orbit = svg.append("path")
            .attr("fill", "none")
            .attr("stroke", "black");
        orbits.push(new_orbit);
    }
    

    var traces = [];
    var trace_arrays = [];
    for (var i = 0; i < nb_bodies; i++) {
        traces[i] = svg.append("g");
        trace_arrays[i] = [];
    }
    

    var shouldDrawTraces = [false, false, false, false, false];
    var shouldDrawOrbits = [false, false, false, false, true];
    var shouldPlay = false;
    var timestamp = 0;
    var addedTime = 0;
    var timer = d3.timer(playOrbit)
        .stop();
    
    var traceSpacing = 5;
    var traceSpacingCounter = 0;

    function togglePlay() {
        shouldPlay = !shouldPlay;
        if (shouldPlay) {
            timer = d3.timer(playOrbit)
        } else {
            timer.stop();
            timestamp += addedTime;
            updateData();
        }
    }

    function playOrbit(t) {

        addedTime = t;
        new_t = timestamp + t;
      
        var x = +heavenly_bodies[0].attr('cx');
        var y = +heavenly_bodies[0].attr('cy');

        for (var i = 1; i < nb_bodies; i++) {

            var angle = new_t/orbital_periods[i] * TAU + orbital_phases[i];
            x += orbital_radii[i] * Math.cos(angle);
            y -= orbital_radii[i] * Math.sin(angle);
            heavenly_bodies[i]
                .attr("cx", x)
                .attr("cy", y)
                .raise();

            if (shouldDrawTraces[i]) { updateTraceOfPlanet(i); }

        }

    }

    function updateData() {
        for (var i = 0; i < nb_bodies; i++) {
            data[i]['cx'] = heavenly_bodies[i]['cx'];
            data[i]['cy'] = heavenly_bodies[i]['cy'];
            if (i > 0) {
                dx = data[i]['cx'] - data[i-1]['cx'];
                dy = data[i]['cy'] - data[i-1]['cy'];
                orbital_phases[i] = Math.atan(dy/dx);
            }
        }
    }


    function updateTraceOfPlanet(i) {

        traceSpacingCounter = (traceSpacingCounter + 1) % traceSpacing;

        if (traceSpacingCounter != 0) { return; }

        var tracePoint = d3.select("svg")
            .select("g")
            .append("circle")
            .attr("cx", x)
            .attr("cy", y)
            .attr("r", 1)
            .attr("fill", "black");
            
        trace_arrays[i].push(tracePoint);
            
        if (traces[i].length > 20) {
            trace_arrays[i][0].remove();
            trace_arrays[i].shift();
        }

    }

    drawOrbits();

    function drawOrbits() {
        for (var i = 0; i < nb_bodies; i++) {
            if (shouldDrawOrbits[i]) { drawOrbitForPlanet(i); }
        }
    }

    function drawOrbitForPlanet(i) {

        T = orbital_periods[i];
        R = orbital_radii[i];
        dt = 0.02 * T;
        start_x = +heavenly_bodies[0].attr('cx');
        start_y = +heavenly_bodies[0].attr('cy');
        for (var j = 0; j <= i; j++) {
            start_x += orbital_radii[j];
        }
        orbit_path_string = "M" + start_x;
        orbit_path_string += " " + start_y;
        
        var t = 0;
        var x0 = heavenly_bodies[i].attr('cx');
        var y0 = heavenly_bodies[i].attr('cy');
        var x = Infinity;
        var y = Infinity;
        var counter = 0;

        while (Math.abs(x - x0) + Math.abs(y - y0) > 1 && counter < 1000) {
            t += dt;
            counter += 1;
            x = +heavenly_bodies[0].attr('cx');
            y = +heavenly_bodies[0].attr('cy');
            for (var j = 1; j <= i; j++) {
                var angle = t/orbital_periods[j] * TAU;
                x += orbital_radii[j] * Math.cos(angle);
                y -= orbital_radii[j] * Math.sin(angle);
            }
            orbit_path_string += "L" + x + " " + y;
        }

        orbits[i].remove();
        orbits[i] = svg.append('path')
            .attr("d", orbit_path_string)
            .attr("fill", "none")
            .attr("stroke", "black");

        console.log(orbits[i]);    
    }

    var dragHandler = d3.drag().on("drag", function() {
      
        dx = d3.event.x - d3.select(this).attr('cx');
        dy = d3.event.y - d3.select(this).attr('cy');

      
        var ii;
        for (var i = 0; i < heavenly_bodies.length; i++) {
            var b = d3.select(this);
            if (heavenly_bodies[i].attr('cx') == b.attr('cx') && heavenly_bodies[i].attr('cy') == b.attr('cy')) {
                ii = i;
                recalculateOrbitalRadiusForPlanet(ii);
            }
            if (i >= ii) {
                planet = heavenly_bodies[i];
                old_cx = +planet.attr('cx');
                old_cy = +planet.attr('cy');
                planet.attr('cx', old_cx + dx);
                planet.attr('cy', old_cy + dy);
            }

        }
        drawOrbits();

    });

    dragHandler(d3.select("svg").selectAll("circle"));
    
    
    function recalculateOrbitalRadiusForPlanet(i) {
        if (i == 0) { return; }
        x1 = heavenly_bodies[i-1].attr('cx');
        y1 = heavenly_bodies[i-1].attr('cy');
        x2 = heavenly_bodies[i].attr('cx');
        y2 = heavenly_bodies[i].attr('cy');
        r = ((x1 - x2)**2 + (y1 - y2)**2)**0.5;
        orbital_radii[i] = r;
    }
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    </script>
</body>

