<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <script src="d3.v4.min.js"></script>
    <style>
        body {
            margin:0;position:fixed;top:0;right:0;bottom:0;left:0;
            font-family: "Helvetica";
            font-size: 25px;
        }
        input {
            font-family: "Helvetica";
            font-size: 25px;
        }
        svg text {
            -webkit-user-select: none;
            -webkit-moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
            font-size: 25px;
            font-family: "Helvetica";
        }
        svg text::selection {
            background: none;
        }

    </style>
</head>

<body>
    <script>

        function linspace(xmin,xmax,n) {
            if (n < 1) {
                return [];
            } else if (n == 1) {
                return [(xmin + xmax)/2];
            }
            else {
                dx = (xmax - xmin)/(n-1);
                var retarr = [xmin];
                for (var i = 1; i < n; i++) {
                    retarr.push(xmin + i * dx);
                }
                return retarr;
            }
        }

        function colorwheel(n) {
            var nb_copies = Math.ceil(n/5);
            var retarr = [];
            for (var i = 0; i < nb_copies; i++) {
                retarr = retarr.concat(['yellow', 'green', 'red', 'cyan', 'gray']);
            }
            return retarr.slice(0,n);
        }


        // CONSTANTS //

        var TAU = 6.283185;
        
        var svg_width = 550;
        var svg_height = 550;

        var nb_bodies = 3;
        var global_period = 6000;

        var body_radii, body_colors, ids, orbital_radii, orbital_frequencies, orbital_periods, orbital_phases, shouldDrawTraces, shouldDrawOrbits, fwd_orbits, back_orbits, upArrow, downArrow, venus_image;


        var body = d3.select("body");
        var svg = body.append("svg")
            .attr("width", svg_width)
            .attr("height",svg_height)
            .call(d3.zoom().on("zoom", zoom));

        var backgroundRect = svg.append('rect')
            .attr('x',0)
            .attr('y',0)
            .attr('width',svg_width)
            .attr('height',svg_height)
            .attr('fill','white')
            .attr('opacity',0)
            .attr('stroke','none');

        d3.select('svg').selectAll('rect').on('click', deselectPlanet);

        function clearOrbits() {
            // INSTANTIATING FORWARD AND BACK ORBITS //
            // again in svg and in an array
            svg.selectAll("path").remove();

            fwd_orbits = [];
            for (var i = 0; i < nb_bodies; i++) {
                var new_orbit = svg.append("path")
                    .attr("fill", "none")
                    .attr("stroke", "none");
                fwd_orbits.push(new_orbit);
            }
            back_orbits = [];
            for (var i = 0; i < nb_bodies; i++) {
                var new_orbit = svg.append("path")
                    .attr("fill", "none")
                    .attr("stroke", "black");
                back_orbits.push(new_orbit);
            }
        }

        function setupPlanets(n) {
            body_radii = linspace(30,20,nb_bodies);
            body_colors = colorwheel(nb_bodies);
            ids = [];
            for (var i = 0; i < 100; i++) {
                ids.push(i);
            }

            shouldDrawTraces = [];
            shouldDrawOrbits = [];
            for (var i = 0; i < nb_bodies; i++) {
                shouldDrawTraces.push(false);
                shouldDrawOrbits.push(false);
            }
            shouldDrawOrbits[nb_bodies - 1] = true;

        }
        
        function setupOrbits(n) {
            
            orbital_radii = linspace(300,70,nb_bodies);
            orbital_radii[0] = 0;

            orbital_frequencies = linspace(1, 3 * (nb_bodies - 1) + 1, nb_bodies);
            orbital_frequencies.splice(0,0,0);
            orbital_periods = [];
            for (var i = 0; i < nb_bodies; i++) {
                orbital_periods.push(global_period/orbital_frequencies[i]);
            }
            orbital_phases = [];
            for (var i = 0; i < nb_bodies; i++) {
                orbital_phases.push(Math.random() * TAU);
            }

        }
        
        setupPlanets(nb_bodies);
        setupOrbits(nb_bodies);
        clearOrbits();

        // CREATING PLANETS IN SVG AND IN ARRAY //

        var heavenly_bodies = [];
        var cx = svg_width/2;
        var cy = svg_height/2;
        for (var i = 0; i < nb_bodies; i++) {
              cx += orbital_radii[i] * Math.cos(orbital_phases[i]);
              cy -= orbital_radii[i] * Math.sin(orbital_phases[i]);
              var new_body = svg.append("circle")
              .attr("cx", cx)
              .attr("cy", cy)
              .attr("r", body_radii[i])
              .attr("fill", body_colors[i])
              .attr("id", ids[i])
              .attr("stroke", "black")
              .attr("stroke-width", 2);
              heavenly_bodies.push(new_body);
        }

        // PLANET LABELS //
        var planet_labels = [];
        for (var i = 1; i < nb_bodies; i++) {
            new_label = svg.append("text")
            .text(orbital_frequencies[i])
            .attr('text-anchor', 'middle')
            .attr('alignment-baseline', 'ideographic')
            .attr('x', heavenly_bodies[i].attr('cx'))
            .attr('y', heavenly_bodies[i].attr('cy'))
            .attr('id', heavenly_bodies[i].attr('id'));
            planet_labels.push(new_label);
        }


        // EPICYCLE CIRCLES //
        var epicycles = [];
        for (var i = 1; i< nb_bodies; i++) {
            var new_epicycle = svg.append("circle")
                .attr("cx", heavenly_bodies[i-1].attr("cx"))
                .attr("cy", heavenly_bodies[i-1].attr("cy"))
                .attr("r", orbital_radii[i])
                .attr("fill", "none")
                .attr("stroke", "black")
                .attr("opacity", 0.3);
            epicycles.push(new_epicycle);
        }

        
        // TRACES (TAILS) //
        var traces = [];
        var trace_arrays = [];
        for (var i = 0; i < nb_bodies; i++) {
            traces[i] = svg.append("g");
            trace_arrays[i] = [];
        }
        var traceSpacing = 5;
        var traceSpacingCounter = 0;
        
        // CREATING TIMER //
        var timestamp = 0;
        var addedTime = 0; // time shift incremented whenever stopping
        var timer = d3.timer(playOrbit)
             .stop();
        
        var shouldPlay = false;
        function togglePlay() {
            shouldPlay = !shouldPlay;
            if (shouldPlay) {
                deselectPlanet();
                document.getElementById('play_button').src = 'pause.png';
                document.getElementById('play_button').width = '64px';
                timer = d3.timer(playOrbit);
            } else {
                timer.stop();
                timestamp += addedTime;
                document.getElementById('play_button').src = 'play.png';
                document.getElementById('play_button').width = '64px';
                updateOrbitalData();
            }
        }
        
        function playOrbit(t) {

            addedTime = t;
            updateEpicycles();
          
            var x = +heavenly_bodies[0].attr('cx');
            var y = +heavenly_bodies[0].attr('cy');

            for (var i = 1; i < nb_bodies; i++) {

                var angle = t/orbital_periods[i] * TAU + orbital_phases[i];
                x += orbital_radii[i] * Math.cos(angle);
                y -= orbital_radii[i] * Math.sin(angle);
                heavenly_bodies[i]
                    .attr("cx", x)
                    .attr("cy", y)
                    .raise();
                planet_labels[i-1]
                    .attr('x', x)
                    .attr('y', y)
                    .raise();

                if (shouldDrawTraces[i]) { updateTraceOfPlanet(i); }
                if (shouldDrawOrbits[i]) { drawOrbitForPlanet(i,t); }

            }
            fixHierarchy();

        }

        function fixHierarchy() {
            for (var i = 0; i < nb_bodies; i++) {
                heavenly_bodies[i].raise();
                if (i != 0) { planet_labels[i-1].raise(); }
            }
            if (upArrowBox != undefined) { upArrowBox.raise(); }
            if (upArrow != undefined) { upArrow.raise(); }
            if (downArrowBox != undefined) { downArrowBox.raise(); }
            if (downArrow != undefined) { downArrow.raise(); }
        }

        var shouldShowEpicycles = true;
        function updateEpicycles() {

            var x = +heavenly_bodies[0].attr('cx');
            var y = +heavenly_bodies[0].attr('cy');

            for (var i = 1; i < nb_bodies; i++) {
                epicycles[i - 1]
                    .attr("cx", x)
                    .attr("cy", y)
                    .attr("r", orbital_radii[i])
                    .raise();
                var angle = (addedTime)/orbital_periods[i] * TAU + orbital_phases[i];
                x += orbital_radii[i] * Math.cos(angle);
                y -= orbital_radii[i] * Math.sin(angle);

            }

            if (shouldShowEpicycles) { showEpicycles(); }
            else { hideEpicycles(); }

            fixHierarchy();
        }

        function showEpicycles() {
            for (var i = 1; i < nb_bodies; i++) {
                epicycles[i - 1].attr('opacity', 0.3);
            }
        }

        function hideEpicycles() {
            for (var i = 1; i < nb_bodies; i++) {
                epicycles[i - 1].attr('opacity',0);
            }
        }

        function toggleEpicycles() {
            shouldShowEpicycles = !shouldShowEpicycles;
            if (shouldShowEpicycles) {
                showEpicycles();
                document.getElementById('epicycles_button').src='epicycles-on.png';
            } else {
                hideEpicycles();
                document.getElementById('epicycles_button').src='epicycles-off.png';
            }
            
        }

        function updateOrbitalDataForPlanet(i) {
            var ddx = +heavenly_bodies[i].attr('cx') - heavenly_bodies[i-1].attr('cx');
            var ddy = +heavenly_bodies[i].attr('cy') - heavenly_bodies[i-1].attr('cy');
            r = (ddx**2 + ddy**2) ** 0.5;
            phi = Math.atan2(-ddy, ddx);
            orbital_radii[i] = r;
            orbital_phases[i] = phi;
        }

        function updateOrbitalData() {
            for (var i = 1; i < nb_bodies; i++) {
                updateOrbitalDataForPlanet(i);
            }
        }

        function updateTraceOfPlanet(i) {

            traceSpacingCounter = (traceSpacingCounter + 1) % traceSpacing;

            if (traceSpacingCounter != 0) { return; }

            var tracePoint = d3.select("svg")
                .select("g")
                .append("circle")
                .attr("cx", x)
                .attr("cy", y)
                .attr("r", 1)
                .attr("fill", "black");
                
            trace_arrays[i].push(tracePoint);
                
            if (traces[i].length > 20) {
                trace_arrays[i][0].remove();
                trace_arrays[i].shift();
            }

        }

        drawOrbits(timestamp);

        function drawOrbits(tt) {
            for (var i = 0; i < nb_bodies; i++) {
                if (shouldDrawOrbits[i]) {drawOrbitForPlanet(i, tt); }
            }
            fixHierarchy();
        }

        function drawOrbitForPlanet(i, tt) {

            //f = Math.abs(orbital_frequencies[i]);
            R = orbital_radii[i];
            nb_steps = 1000;
            var dt = global_period/nb_steps;
            // if (f != 0) {
            //     dt = 0.005 * global_period/f;
            // } else {
            //     dt = 0.005 * global_period;
            // }
            
            var fwd_t = +tt;
            var back_t = +tt;
            var start_x = +heavenly_bodies[i].attr('cx');
            var start_y = +heavenly_bodies[i].attr('cy');
            var x0 = +heavenly_bodies[0].attr('cx');
            var y0 = +heavenly_bodies[0].attr('cy');
            var fwd_x = Infinity;
            var fwd_y = Infinity;
            var back_x = Infinity;
            var back_y = Infinity;
            var counter = 0;

            fwd_orbit_path_string = "M" + start_x + " " + start_y;
            back_orbit_path_string = fwd_orbit_path_string;

            while (counter < nb_steps) {
                fwd_t += dt;
                back_t -= dt;
                counter += 1;
                fwd_x = x0;
                fwd_y = y0;
                back_x = x0;
                back_y = y0;
                for (var j = 1; j <= i; j++) {
                    var fwd_angle = fwd_t/global_period*orbital_frequencies[j] * TAU;
                    var back_angle = back_t/global_period*orbital_frequencies[j] * TAU;
                    var r = +orbital_radii[j];
                    var phi = +orbital_phases[j];
                    fwd_x += r * Math.cos(fwd_angle + phi);
                    fwd_y -= r * Math.sin(fwd_angle + phi);
                    back_x += r * Math.cos(back_angle + phi);
                    back_y -= r * Math.sin(back_angle + phi);
                }
                fwd_orbit_path_string += "L" + fwd_x + " " + fwd_y;
                back_orbit_path_string += "L" + back_x + " " + back_y;
            }

            fwd_orbits[i].remove();
            fwd_orbits[i] = svg.append('path')
                .attr("d", fwd_orbit_path_string)
                .attr("fill", "none")
                .attr("stroke", "none")
                .attr("transform", svg.attr('transform')); 

            back_orbits[i].remove();
            back_orbits[i] = svg.append('path')
                .attr("d", back_orbit_path_string)
                .attr("fill", "none")
                .attr("stroke", "black")
                .attr("transform", svg.attr('transform'));
        }

        function dragPlanet() {

            deselectPlanet();
            addedTime = 0;
          
            var b = d3.select(this); // the planet or label registering the drag
            var ii = +b.attr('id');
            draggedPlanet = heavenly_bodies[ii];
            dx = zoomInverseTransformX(d3.event.x) - draggedPlanet.attr('cx');
            dy = zoomInverseTransformY(d3.event.y) - draggedPlanet.attr('cy');

            for (var i = 0; i < heavenly_bodies.length; i++) {
                if (i >= ii) {
                    planet = heavenly_bodies[i];
                    old_cx = +planet.attr('cx');
                    old_cy = +planet.attr('cy');

          
                    planet
                        .attr('cx', old_cx + dx)
                        .attr('cy', old_cy + dy);
                    if (i != 0) {
                        label = planet_labels[i-1];
                        label
                            .attr('x', old_cx + dx)
                            .attr('y', old_cy + dy);
                    }
                }
                if (i != 0) {
                    updateOrbitalDataForPlanet(i);
                }
            }
            drawOrbits(0);
            updateEpicycles();
        }

        var dragHandler = d3.drag().on("drag", dragPlanet);

        dragHandler(d3.select("svg").selectAll("circle"));
        dragHandler(d3.select("svg").selectAll("text"));
        
        function increment_frequency() {
            var ii;
            var b = d3.select(this); // the clicked arrow
            for (var i = 1; i < heavenly_bodies.length; i++) {
                if (planet_labels[i - 1].attr('id') == b.attr('id')) {
                    ii = i;
                }
            }

            orbital_frequencies[ii]++;
            orbital_periods[ii] = global_period/orbital_frequencies[ii];
            planet_labels[ii-1].text(orbital_frequencies[ii]);
            drawOrbits(0);
        }

        function decrement_frequency() {
            var ii;
            var b = d3.select(this); // the clicked arrow
            for (var i = 1; i < heavenly_bodies.length; i++) {
                if (planet_labels[i - 1].attr('id') == b.attr('id')) {
                    ii = i;
                }
            }
            orbital_frequencies[ii]--;
            orbital_periods[ii] = global_period/orbital_frequencies[ii];
            planet_labels[ii-1].text(orbital_frequencies[ii]);
            drawOrbits(0);
        }

        d3.select('svg').selectAll('circle').on("click", selectPlanet);
        d3.select('svg').selectAll('text').on("click", selectPlanet);

    
    
        function addPlanet() {

            if (shouldPlay) { return; }

            nb_bodies++;
            setupPlanets(nb_bodies);
            clearOrbits();

            for (var i = 0; i < nb_bodies - 1; i++) {
                heavenly_bodies[i]
                    .attr("r", body_radii[i])
                    .attr("fill", body_colors[i])
                    .attr("id", ids[i]);
            }
            orbital_radii[nb_bodies - 1] = orbital_radii[nb_bodies - 2];
            orbital_frequencies[nb_bodies - 1] = 0;
            orbital_periods[nb_bodies - 1] = global_period/orbital_frequencies[nb_bodies - 1];
            orbital_phases[nb_bodies - 1] = 0;

            var cx = +heavenly_bodies[0].attr('cx');
            var cy = +heavenly_bodies[0].attr('cy');
            for (var i = 0; i < nb_bodies - 1; i++) {
                cx += orbital_radii[i] * Math.cos(orbital_phases[i]);
                cy -= orbital_radii[i] * Math.sin(orbital_phases[i]);
            }

            var new_epicycle = svg.append('circle')
                .attr('cx',cx)
                .attr('cy',cy)
                .attr('stroke','gray')
                .attr('fill','none');
            epicycles.push(new_epicycle);

            cx += orbital_radii[nb_bodies - 1] * Math.cos(orbital_phases[nb_bodies - 1]);
            cy -= orbital_radii[nb_bodies - 1] * Math.sin(orbital_phases[nb_bodies - 1]);

            var new_body = svg.append("circle")
                .attr("cx", cx)
                .attr("cy", cy)
                .attr("r", body_radii[nb_bodies - 1])
                .attr("fill", body_colors[nb_bodies - 1])
                .attr("id", ids[nb_bodies - 1])
                .attr("stroke", "black");
            heavenly_bodies.push(new_body);

            var new_label = svg.append("text")
                .text(orbital_frequencies[nb_bodies - 1])
                .attr('text-anchor', 'middle')
                .attr('alignment-baseline', 'ideographic')
                .attr('x', heavenly_bodies[nb_bodies - 1].attr('cx'))
                .attr('y', heavenly_bodies[nb_bodies - 1].attr('cy'))
                .attr('id', heavenly_bodies[nb_bodies - 1].attr('id'));
            planet_labels.push(new_label);

            dragHandler(new_body);
            dragHandler(new_label);
            new_body.on("click", selectPlanet);
            new_label.on("click", selectPlanet);

            updateEpicycles();
            drawOrbits(0);

        }
    
        function removePlanet() {
            
            if (shouldPlay) { return; }
            heavenly_bodies[nb_bodies - 1].remove();
            planet_labels[nb_bodies - 2].remove();
            epicycles[nb_bodies - 2].remove();
            heavenly_bodies.pop();
            planet_labels.pop();
            epicycles.pop();

            nb_bodies--;
            setupPlanets(nb_bodies);
            clearOrbits();
            drawOrbits(0);
        }
    
        var selectedPlanet;
        var upArrowBox, downArrowBox;

        function selectPlanet() {
            deselectPlanet();
            var ii = +d3.select(this).attr('id');
            if (ii == 0) { return; }
            var planet = heavenly_bodies[ii];
            selectedPlanet = planet;

            planet.attr('stroke-width', 5);

            for (var i = 0; i < nb_bodies; i++) {
                if (i != ii) {
                    heavenly_bodies[i].attr('opacity', 0.3);
                    if (i != 0) { planet_labels[i - 1].attr('opacity', 0.3); }
                }
            }

            upArrowBox = svg.append('rect')
                .attr('x', +planet.attr('cx') + 10)
                .attr('y', +planet.attr('cy') - 30)
                .attr('width', 30)
                .attr('height', 30)
                .attr('fill', 'white')
                .attr('stroke', 'black');
            upArrow = svg.append('text')
                .text("⬆︎")
                .attr('text-anchor', 'left')
                .attr('x', +planet.attr('cx') + 12)
                .attr('y', +planet.attr('cy') - 5)
                .attr('id', planet.attr('id'));
            downArrowBox = svg.append('rect')
                .attr('x', +planet.attr('cx') + 10)
                .attr('y', +planet.attr('cy'))
                .attr('width', 30)
                .attr('height', 30)
                .attr('fill', 'white')
                .attr('stroke', 'black');
            downArrow = svg.append('text')
                .text("⬇︎")
                .attr('text-anchor', 'left')
                .attr('x', +planet.attr('cx') + 12)
                .attr('y', +planet.attr('cy') + 25)
                .attr('id', planet.attr('id'));
            upArrow.on('click', increment_frequency);
            downArrow.on('click', decrement_frequency);

        }
    
        function deselectPlanet() {
            if (selectedPlanet != undefined) {
                selectedPlanet.attr('stroke-width', 2);
                for (var i = 0; i < nb_bodies; i++) {
                    heavenly_bodies[i].attr('opacity', 1);
                    if (i < nb_bodies - 1) {
                        planet_labels[i].attr('opacity', 1);
                    }
                }
                selectedPlanet = undefined;
            }
            if (upArrow != undefined) {
                upArrow.remove();
                upArrow = undefined;
            }
            if (downArrow != undefined) {
                downArrow.remove();
                downArrow = undefined;
            }
            if (upArrowBox != undefined) {
                upArrowBox.remove();
                upArrowBox = undefined;
            }
            if (downArrowBox != undefined) {
                downArrowBox.remove();
                downArrowBox = undefined;
            }
        }

        var T = d3.zoomIdentity;
        function zoom() {
            T = d3.event.transform;
            svg.attr("transform", T);
            svg.selectAll('circle').attr("transform", T);
            svg.selectAll('path').attr("transform", T);
            svg.selectAll('g').attr("transform", T);
            svg.selectAll('text').attr("transform", T);
        }

        function zoomTransformX(x) {
            return T.k * x + T.x;
        }

        function zoomTransformY(y) {
            return T.k * y + T.y;
        }
    
        function zoomInverseTransformX(x) {
            return (x - T.x)/T.k;
        }

        function zoomInverseTransformY(y) {
            return (y - T.y)/T.k;
        }
    
    </script>

    <br/>
    <span>&nbsp;</span>
    <img onclick="togglePlay();" id='play_button' style='width: 64px;' src='play.png'></img>
    <img onclick="addPlanet();" id='add_planet_button' style='width: 64px;' src='plus.png'></img>
    <img onclick="removePlanet();" id='remove_planet_button' style='width: 64px;' src='minus.png'></img>
    <img onclick="toggleEpicycles();" id='epicycles_button' style='width: 64px;' src='epicycles-on.png'></img>
    <img onclick="toggleLinks();" id='links_button' style='width: 64px;' src='links-off.png'></img>
    <img onclick="toggleTraces();" id='traces_button' style='width: 64px;' src='traces.png'></img>
    <input type="checkbox" name="venus" value="venus"
               value="show_venus" /><label for="venus"></label>
    </div>
    <script>


        venusCheckbox = document.querySelector('input[value="venus"]');
        venusCheckbox.onchange = function() {
            if (venusCheckbox.checked) {
                venus_image = d3.selectAll('svg').insert('image','rect')
                    .attr('xlink:href', 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/89/Venus_geocentric_orbit_curve_simplified_Line_%28pentagram%29.svg/602px-Venus_geocentric_orbit_curve_simplified_Line_%28pentagram%29.svg.png')
                    .attr('x', 0)
                    .attr('y', 0)
                    .attr('width', svg_width)
                    .attr('height', svg_height)
                    .attr('opacity', 0.2);
            } else {
                if (venus_image != undefined) {
                    venus_image.remove();
                }
            }
        };
    </script>
    


</body>

