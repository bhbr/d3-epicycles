<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <script src="d3.v4.min.js"></script>
    <style>
        body {
            margin:0;position:fixed;top:0;right:0;bottom:0;left:0;
            font-family: "Helvetica";
            font-size: 25px;
        }
        input {
            font-family: "Helvetica";
            font-size: 25px;
        }
        svg text {
            -webkit-user-select: none;
            -webkit-moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
            font-size: 25px;
            font-family: "Helvetica";
        }
        svg text::selection {
            background: none;
        }

    </style>
</head>

<body>
    <script>

        function linspace(xmin,xmax,n) {
            if (n < 1) {
                return [];
            } else if (n == 1) {
                return [(xmin + xmax)/2];
            }
            else {
                dx = (xmax - xmin)/(n-1);
                var retarr = [xmin];
                for (var i = 1; i < n; i++) {
                    retarr.push(xmin + i * dx);
                }
                return retarr;
            }
        }

        function colorwheel(n) {
            var nb_copies = Math.ceil(n/5);
            var retarr = [];
            for (var i = 0; i < nb_copies; i++) {
                retarr = retarr.concat([
                    'url(#gradient1)',
                    'url(#gradient2)',
                    'url(#gradient3)',
                    'url(#gradient4)',
                    'url(#gradient5)',
                ]);
            }
            return retarr.slice(0,n);
        }


        // CONSTANTS //

        var TAU = 6.283185;
        
        var svg_width = 1200;
        var svg_height = 780;

        var nb_bodies = 9;
        var global_period = 15000;

        var body_radii, body_colors, ids, orbital_radii, orbital_frequencies, orbital_periods, orbital_phases, shouldDrawTrace, shouldDrawOrbit, orbit, upArrow, downArrow, venus_image, heavenly_bodies, planet_labels, epicycles, links, trace, trace_array, dragstart_x, dragstart_y;

        shouldDrawOrbit = false;
        shouldDrawTrace = true;

        traceSpacing = 5;
        traceSpacingCounter = 0;
        maxTraceSize = 100;

        var body = d3.select("body");
        var svg = body.append("svg")
            .attr("width", svg_width)
            .attr("height",svg_height)
            .call(d3.zoom().on("zoom", zoom))
            .on("dblclick.zoom", null);

        var backgroundRect = svg.append('rect')
            .attr('x',0)
            .attr('y',0)
            .attr('width',svg_width)
            .attr('height',svg_height)
            .attr('fill','black')
            .attr('opacity',1)
            .attr('stroke','none');

        d3.select('svg').selectAll('rect').on('click', deselectPlanet);


        function defineGradients() {

            var defs = svg.append("defs");

            var gradient1 = defs.append("linearGradient")
               .attr("id", "gradient1")
               .attr("x1", "50%")
               .attr("x2", "50%")
               .attr("y1", "0%")
               .attr("y2", "100%");

            gradient1.append("stop")
               .attr('class', 'start')
               .attr("offset", "0%")
               .attr("stop-color", "#DD0")
               .attr("stop-opacity", 1);

            gradient1.append("stop")
               .attr('class', 'end')
               .attr("offset", "100%")
               .attr("stop-color", "#770")
               .attr("stop-opacity", 1);


            var gradient2 = defs.append("linearGradient")
               .attr("id", "gradient2")
               .attr("x1", "50%")
               .attr("x2", "50%")
               .attr("y1", "0%")
               .attr("y2", "100%");

            gradient2.append("stop")
               .attr('class', 'start')
               .attr("offset", "0%")
               .attr("stop-color", "#0D0")
               .attr("stop-opacity", 1);

            gradient2.append("stop")
               .attr('class', 'end')
               .attr("offset", "100%")
               .attr("stop-color", "#070")
               .attr("stop-opacity", 1);


            var gradient3 = defs.append("linearGradient")
               .attr("id", "gradient3")
               .attr("x1", "50%")
               .attr("x2", "50%")
               .attr("y1", "0%")
               .attr("y2", "100%");

            gradient3.append("stop")
               .attr('class', 'start')
               .attr("offset", "0%")
               .attr("stop-color", "#D00")
               .attr("stop-opacity", 1);

            gradient3.append("stop")
               .attr('class', 'end')
               .attr("offset", "100%")
               .attr("stop-color", "#700")
               .attr("stop-opacity", 1);


            var gradient4 = defs.append("linearGradient")
               .attr("id", "gradient4")
               .attr("x1", "50%")
               .attr("x2", "50%")
               .attr("y1", "0%")
               .attr("y2", "100%");

            gradient4.append("stop")
               .attr('class', 'start')
               .attr("offset", "0%")
               .attr("stop-color", "#07F")
               .attr("stop-opacity", 1);

            gradient4.append("stop")
               .attr('class', 'end')
               .attr("offset", "100%")
               .attr("stop-color", "#00F")
               .attr("stop-opacity", 1);


            var gradient5 = defs.append("linearGradient")
               .attr("id", "gradient5")
               .attr("x1", "50%")
               .attr("x2", "50%")
               .attr("y1", "0%")
               .attr("y2", "100%");

            gradient5.append("stop")
               .attr('class', 'start')
               .attr("offset", "0%")
               .attr("stop-color", "#B0B")
               .attr("stop-opacity", 1);

            gradient5.append("stop")
               .attr('class', 'end')
               .attr("offset", "100%")
               .attr("stop-color", "#505")
               .attr("stop-opacity", 1);

        }
        defineGradients();


        function setupPlanets(n) {
            //body_radii = linspace(30,20,nb_bodies);
            body_radii = [30];
            for (var i = 0; i < 100; i++) {
                body_radii.push(0.75 * body_radii[body_radii.length - 1]);
            }
            body_colors = colorwheel(100);
            ids = [];
            for (var i = 0; i < 100; i++) {
                ids.push(i);
            }

        }
        
        function setupOrbitalData(n) {
            
            //orbital_radii = linspace(300,70,nb_bodies);
            r = 200;
            orbital_radii = [r, r/5, r/7, r/11, r/13, r/17, r/19, r/23, r/25];
            orbital_radii.splice(0,0,0);

            //orbital_frequencies = linspace(1, 3 * (nb_bodies - 1) + 1, nb_bodies);
            orbital_frequencies = [1,-5,7,-11,13,-17,19,-23,25];
            orbital_frequencies.splice(0,0,0);
            orbital_periods = [];
            for (var i = 0; i < nb_bodies; i++) {
                orbital_periods.push(global_period/orbital_frequencies[i]);
            }
            // orbital_phases = [];
            // for (var i = 0; i < nb_bodies; i++) {
            //     orbital_phases.push(Math.random() * TAU);
            // }
            orbital_phases = [-TAU/12, 5/12*TAU,-TAU/12, 5/12*TAU,-TAU/12, 5/12*TAU,-TAU/12, 5/12*TAU,-TAU/12];

        }
        
        function clearOrbit() {
            // INSTANTIATING ORBIT PATH //
            // again in svg and in an array
            svg.selectAll("#orbit").remove();

            orbit = svg.append("path")
                .attr("fill", "none")
                .attr("stroke", "none");
        }

        function createSVGElements() {

            // CREATING PLANETS IN SVG AND IN ARRAY //

            heavenly_bodies = [];
            var cx = svg_width/2;
            var cy = svg_height/2;
            for (var i = 0; i < nb_bodies; i++) {
                  cx += orbital_radii[i] * Math.cos(orbital_phases[i]);
                  cy -= orbital_radii[i] * Math.sin(orbital_phases[i]);
                  var new_body = svg.append("circle")
                  .attr("cx", cx)
                  .attr("cy", cy)
                  .attr("r", body_radii[i])
                  .attr("fill", body_colors[i])
                  .attr("id", ids[i])
                  .attr("stroke-width", 0);
                  heavenly_bodies.push(new_body);
            }

            // PLANET LABELS //
            planet_labels = [];
            for (var i = 1; i < nb_bodies; i++) {
                new_label = svg.append("text")
                .text(orbital_frequencies[i])
                .attr('fill', 'white')
                .style('font-size', 1.2 * heavenly_bodies[i].attr('r') + 'px')
                .attr('text-anchor', 'middle')
                .attr('alignment-baseline', 'central')
                .attr('x', heavenly_bodies[i].attr('cx'))
                .attr('y', heavenly_bodies[i].attr('cy'))
                .attr('id', heavenly_bodies[i].attr('id'));
                planet_labels.push(new_label);
            }


            // EPICYCLE CIRCLES //
            epicycles = [];
            for (var i = 1; i< nb_bodies; i++) {
                var new_epicycle = svg.append("circle")
                    .attr("cx", heavenly_bodies[i-1].attr("cx"))
                    .attr("cy", heavenly_bodies[i-1].attr("cy"))
                    .attr("r", orbital_radii[i])
                    .attr("fill", "none")
                    .attr("stroke", "gray")
                    .attr('stroke-width', 2)
                    .attr("opacity", 0.6);
                epicycles.push(new_epicycle);
            }

            // LINKS //
            links = [];
            for (var i = 1; i< nb_bodies; i++) {
                var x0 = heavenly_bodies[i-1].attr("cx");
                var y0 = heavenly_bodies[i-1].attr("cy");
                var x1 = heavenly_bodies[i].attr("cx");
                var y1 = heavenly_bodies[i].attr("cy");
                var new_link = svg.append("path")
                    .attr('d', 'M' + x0 + ' ' + y0 + 'L' + x1 + ' ' + y1)
                    .attr("stroke", "gray")
                    .attr('stroke-width', 2)
                    .attr("opacity", 0);
                links.push(new_link);
            }
            fixHierarchy();
            
            // TRACES (TAILS) //
            trace = svg.append("g");
            trace_array = [];

        }

        setupPlanets(nb_bodies);
        setupOrbitalData(nb_bodies);
        clearOrbit();
        createSVGElements();
        
        // CREATING TIMER //
        var timestamp = 0;
        var addedTime = 0; // time shift incremented whenever stopping
        var timer = d3.timer(play)
             .stop();
        
        var shouldPlay = false;
        function togglePlay() {
            shouldPlay = !shouldPlay;
            if (shouldPlay) {
                deselectPlanet();
                document.getElementById('play_button').src = 'pause.png';
                document.getElementById('play_button').width = '64px';
                document.getElementById('add_planet_button').style = 'opacity: 0.3; width: 64px;';
                document.getElementById('remove_planet_button').style = 'opacity: 0.3; width: 64px;';
                timer = d3.timer(play);
            } else {
                timer.stop();
                timestamp += addedTime;
                document.getElementById('play_button').src = 'play.png';
                document.getElementById('play_button').width = '64px';
                document.getElementById('add_planet_button').style = 'opacity: 1; width: 64px;';
                document.getElementById('remove_planet_button').style = 'opacity: 1; width: 64px;';
                updateOrbitalData();
            }
        }
        
        function play(t) {

            addedTime = t;
            updateEpicycles();
            updateLinks();
          
            var x = +heavenly_bodies[0].attr('cx');
            var y = +heavenly_bodies[0].attr('cy');

            for (var i = 1; i < nb_bodies; i++) {

                var angle = t/orbital_periods[i] * TAU + orbital_phases[i];
                console.log(angle);
                x += orbital_radii[i] * Math.cos(angle);
                y -= orbital_radii[i] * Math.sin(angle);
                heavenly_bodies[i]
                    .attr("cx", x)
                    .attr("cy", y)
                    .raise();
                planet_labels[i-1]
                    .attr('x', x)
                    .attr('y', y)
                    .raise();

                //if (shouldDrawOrbits[i]) { drawOrbitForPlanet(i,t); }

            }
            if (shouldDrawTrace) { updateTrace(); }
            fixHierarchy();

        }

        function fixHierarchy() {
            for (var i = 0; i < nb_bodies; i++) {
                heavenly_bodies[i].raise();
                if (i != 0) { planet_labels[i-1].raise(); }
            }
            if (upArrowBox != undefined) { upArrowBox.raise(); }
            if (upArrow != undefined) { upArrow.raise(); }
            if (downArrowBox != undefined) { downArrowBox.raise(); }
            if (downArrow != undefined) { downArrow.raise(); }
        }

        var shouldShowEpicycles = true;
        function updateEpicycles() {

            var x = +heavenly_bodies[0].attr('cx');
            var y = +heavenly_bodies[0].attr('cy');

            for (var i = 1; i < nb_bodies; i++) {
                epicycles[i - 1]
                    .attr("cx", x)
                    .attr("cy", y)
                    .attr("r", orbital_radii[i])
                    .raise();
                var angle = (addedTime)/orbital_periods[i] * TAU + orbital_phases[i];
                x += orbital_radii[i] * Math.cos(angle);
                y -= orbital_radii[i] * Math.sin(angle);

            }

            if (shouldShowEpicycles) { showEpicycles(); }
            else { hideEpicycles(); }

            fixHierarchy();
        }

        function showEpicycles() {
            for (var i = 1; i < nb_bodies; i++) {
                epicycles[i - 1].attr('opacity', 0.6);
            }
        }

        function hideEpicycles() {
            for (var i = 1; i < nb_bodies; i++) {
                epicycles[i - 1].attr('opacity',0);
            }
        }

        function toggleEpicyclesAndLinks() {

            if (shouldShowEpicycles) {
                shouldShowEpicycles = false;
                shouldShowLinks = true;
                document.getElementById('epicycles_button').src='links-on.png';
            } else if (shouldShowLinks) {
                shouldShowLinks = false;
                document.getElementById('epicycles_button').src='planets.png';
            } else {
                shouldShowEpicycles = true;
                document.getElementById('epicycles_button').src='epicycles-on.png';
            }

            if (shouldShowEpicycles) {
                showEpicycles();
            } else {
                hideEpicycles();
            }

            if (shouldShowLinks) {
                showLinks();
            } else {
                hideLinks();
            }
            
        }

        var shouldShowLinks = false;
        function updateLinks() {
            var x = +heavenly_bodies[0].attr('cx');
            var y = +heavenly_bodies[0].attr('cy');

            for (var i = 1; i < nb_bodies; i++) {
                var x0 = heavenly_bodies[i-1].attr("cx");
                var y0 = heavenly_bodies[i-1].attr("cy");
                var x1 = heavenly_bodies[i].attr("cx");
                var y1 = heavenly_bodies[i].attr("cy");
                links[i - 1].attr('d', 'M' + x0 + ' ' + y0 + 'L' + x1 + ' ' + y1)
                    .raise();
                var angle = (addedTime)/orbital_periods[i] * TAU + orbital_phases[i];
                x += orbital_radii[i] * Math.cos(angle);
                y -= orbital_radii[i] * Math.sin(angle);

            }

            if (shouldShowLinks) { showLinks(); }
            else { hideLinks(); }

            fixHierarchy();
        }

        function showLinks() {
            for (var i = 1; i < nb_bodies; i++) {
                links[i - 1].attr('opacity', 0.6);
            }
        }

        function hideLinks() {
            for (var i = 1; i < nb_bodies; i++) {
                links[i - 1].attr('opacity',0.0);
            }
        }

        function toggleLinks() {
            shouldShowLinks = !shouldShowLinks;
            if (shouldShowLinks) {
                showLinks();
                document.getElementById('links_button').src='links-on.png';
            } else {
                hideLinks();
                document.getElementById('links_button').src='links-off.png';
            }
            
        }
        function updateOrbitalDataForPlanet(i) {
            var ddx = +heavenly_bodies[i].attr('cx') - heavenly_bodies[i-1].attr('cx');
            var ddy = +heavenly_bodies[i].attr('cy') - heavenly_bodies[i-1].attr('cy');
            r = (ddx**2 + ddy**2) ** 0.5;
            phi = Math.atan2(-ddy, ddx);
            orbital_radii[i] = r;
            orbital_phases[i] = phi;
        }

        function updateOrbitalData() {
            for (var i = 1; i < nb_bodies; i++) {
                updateOrbitalDataForPlanet(i);
            }
        }

        function updateTrace() {

            traceSpacingCounter = (traceSpacingCounter + 1) % traceSpacing;

            if (traceSpacingCounter != 0) { return; }

            var x = heavenly_bodies[nb_bodies - 1].attr('cx');
            var y = heavenly_bodies[nb_bodies - 1].attr('cy');

            var tracePoint = d3.select("svg")
                .select("g")
                .append("circle")
                .attr("cx", x)
                .attr("cy", y)
                .attr("r", 2)
                .attr("fill", "white");
                
            trace_array.push(tracePoint);
                
            if (trace_array.length > maxTraceSize) {
                trace_array[0].remove();
                trace_array.shift();
            }

        }

        updateTrace();


        function drawOrbit(tt) {

            nb_steps = 1000;
            var dt = global_period/nb_steps;
            var fwd_t = tt;
            //var start_x = +heavenly_bodies[nb_bodies - 1].attr('cx');
            //var start_y = +heavenly_bodies[nb_bodies - 1].attr('cy');
            var x0 = +heavenly_bodies[0].attr('cx');
            var y0 = +heavenly_bodies[0].attr('cy');
            var counter = 0;

            orbit_path_string = "";// "M" + start_x + " " + start_y;

            while (counter < nb_steps) {
                fwd_t += dt;
                counter += 1;
                var x = x0;
                var y = y0;
                for (var j = 1; j < nb_bodies; j++) {
                    var fwd_angle = fwd_t/global_period*orbital_frequencies[j] * TAU;
                    var r = +orbital_radii[j];
                    var phi = +orbital_phases[j];
                    x += r * Math.cos(fwd_angle + phi);
                    y -= r * Math.sin(fwd_angle + phi);
                }
                if (counter == 1) {
                    orbit_path_string += "M";
                } else {
                    orbit_path_string += "L";
                }
                orbit_path_string += x + " " + y;
            }
            orbit_path_string += "Z";

            orbit.remove();
            orbit = svg.append('path')
                .attr('id','orbit')
                .attr("d", orbit_path_string)
                .attr("fill", "none")
                .attr("stroke", "white")
                .attr('stroke-width', 2)
                .attr("transform", svg.attr('transform')); 

            fixHierarchy();
        }

        function toggleTrace() {
            shouldDrawOrbit = !shouldDrawOrbit;
            shouldDrawTrace = !shouldDrawTrace;
            if (shouldDrawOrbit) {
                eraseTrace();
                drawOrbit(0);
                document.getElementById('trace_button').src = 'show_orbit.png';
            }
            if (shouldDrawTrace) {
                orbit.remove();
                updateTrace();
                document.getElementById('trace_button').src = 'show_trace.png';
            }
        }

        function eraseTrace() {
            for (var i = 0; i < trace_array.length; i++) {
                trace_array[i].remove();
            }
            trace_array = [];
        }

        function anchorDragStart() {
            var b = d3.select(this); // the planet or label registering the drag
            var ii = +b.attr('id');
            p = heavenly_bodies[ii];
            dragstart_x = zoomInverseTransformX(d3.event.x) - p.attr('cx');
            dragstart_y = zoomInverseTransformY(d3.event.y) - p.attr('cy');
            // relative to initial planet center
        }

        function dragPlanet() {

            deselectPlanet();
            eraseTrace();
            addedTime = 0;

          
            var b = d3.select(this); // the planet or label registering the drag
            var ii = +b.attr('id');
            draggedPlanet = heavenly_bodies[ii];
            dx = zoomInverseTransformX(d3.event.x) - dragstart_x - draggedPlanet.attr('cx');
            dy = zoomInverseTransformY(d3.event.y) - dragstart_y - draggedPlanet.attr('cy');

            for (var i = 0; i < heavenly_bodies.length; i++) {
                if (i >= ii) {
                    planet = heavenly_bodies[i];
                    old_cx = +planet.attr('cx');
                    old_cy = +planet.attr('cy');

          
                    planet
                        .attr('cx', old_cx + dx)
                        .attr('cy', old_cy + dy);
                    if (i != 0) {
                        label = planet_labels[i-1];
                        label
                            .attr('x', old_cx + dx)
                            .attr('y', old_cy + dy);
                    }
                }
                if (i != 0) {
                    updateOrbitalDataForPlanet(i);
                }
            }
            if (shouldDrawOrbit) { drawOrbit(0); }
            updateEpicycles();
            updateLinks();
        }

        var dragHandler = d3.drag()
            .on('start', anchorDragStart)
            .on("drag", dragPlanet);

        dragHandler(d3.select("svg").selectAll("circle"));
        dragHandler(d3.select("svg").selectAll("text"));
        
        function increment_frequency() {
            var ii;
            eraseTrace();
            var b = d3.select(this); // the clicked arrow
            for (var i = 1; i < heavenly_bodies.length; i++) {
                if (planet_labels[i - 1].attr('id') == b.attr('id')) {
                    ii = i;
                }
            }

            orbital_frequencies[ii]++;
            orbital_periods[ii] = global_period/orbital_frequencies[ii];
            planet_labels[ii-1].text(orbital_frequencies[ii]);
            if (shouldDrawOrbit) { drawOrbit(0); }
        }

        function decrement_frequency() {
            var ii;
            eraseTrace();
            var b = d3.select(this); // the clicked arrow
            for (var i = 1; i < heavenly_bodies.length; i++) {
                if (planet_labels[i - 1].attr('id') == b.attr('id')) {
                    ii = i;
                }
            }
            orbital_frequencies[ii]--;
            orbital_periods[ii] = global_period/orbital_frequencies[ii];
            planet_labels[ii-1].text(orbital_frequencies[ii]);
            if (shouldDrawOrbit) { drawOrbit(0); }
        }

        d3.select('svg').selectAll('circle').on("click", selectPlanet);
        d3.select('svg').selectAll('text').on("click", selectPlanet);

    
    
        function addPlanet() {

            if (shouldPlay) { return; }

            nb_bodies++;
            eraseTrace();
            setupPlanets(nb_bodies);
            clearOrbit();

            for (var i = 0; i < nb_bodies - 1; i++) {
                heavenly_bodies[i]
                    .attr("r", body_radii[i])
                    .attr("fill", body_colors[i])
                    .attr("id", ids[i])
            }
            orbital_radii[nb_bodies - 1] = orbital_radii[nb_bodies - 2]/3;
            orbital_frequencies[nb_bodies - 1] = 1;
            orbital_periods[nb_bodies - 1] = global_period/orbital_frequencies[nb_bodies - 1];
            orbital_phases[nb_bodies - 1] = 0;

            var cx = +heavenly_bodies[0].attr('cx');
            var cy = +heavenly_bodies[0].attr('cy');
            for (var i = 0; i < nb_bodies - 1; i++) {
                cx += orbital_radii[i] * Math.cos(orbital_phases[i]);
                cy -= orbital_radii[i] * Math.sin(orbital_phases[i]);
            }

            var new_epicycle = svg.append('circle')
                .attr('cx',cx)
                .attr('cy',cy)
                .attr('stroke','gray')
                .attr('stroke-width', 2)
                .attr('fill','none')
                .attr('transform',T);
            epicycles.push(new_epicycle);

            new_cx = cx + orbital_radii[nb_bodies - 1] * Math.cos(orbital_phases[nb_bodies - 1]);
            new_cy = cy - orbital_radii[nb_bodies - 1] * Math.sin(orbital_phases[nb_bodies - 1]);


            var new_link = svg.append('path')
                .attr('d', 'M' + cx + ' ' + cy + 'L' + new_cx + ' ' + new_cy)
                .attr("stroke", "gray")
                .attr('stroke-width', 2)
                .attr('transform',T);
            if (shouldShowLinks) {
                new_link.attr("opacity", 0.6);
                links.push(new_link);
                showLinks();
            } else {
                new_link.attr("opacity", 0);
                links.push(new_link);
                hideLinks();
            }

            var new_body = svg.append("circle")
                .attr("cx", new_cx)
                .attr("cy", new_cy)
                .attr("r", body_radii[nb_bodies - 1])
                .attr("fill", body_colors[nb_bodies - 1])
                .attr("id", ids[nb_bodies - 1])
                .attr("stroke", "none")
                .attr('transform',T);
            heavenly_bodies.push(new_body);

            var new_label = svg.append("text")
                .text(orbital_frequencies[nb_bodies - 1])
                .attr('fill', 'white')
                .style('font-size', 1.6 * heavenly_bodies[nb_bodies - 1].attr('r') + 'px')
                .attr('text-anchor', 'middle')
                .attr('alignment-baseline', 'central')
                .attr('x', heavenly_bodies[nb_bodies - 1].attr('cx'))
                .attr('y', heavenly_bodies[nb_bodies - 1].attr('cy'))
                .attr('id', heavenly_bodies[nb_bodies - 1].attr('id'))
                .attr('transform',T);
            planet_labels.push(new_label);

            dragHandler(new_body);
            dragHandler(new_label);
            new_body.on("click", selectPlanet);
            new_label.on("click", selectPlanet);

            updateEpicycles();
            if (shouldDrawOrbit) { drawOrbit(0); }

        }
    
        function removePlanet() {
            
            if (shouldPlay) { return; }
            eraseTrace();
            heavenly_bodies[nb_bodies - 1].remove();
            planet_labels[nb_bodies - 2].remove();
            epicycles[nb_bodies - 2].remove();
            links[nb_bodies - 2].remove();
            heavenly_bodies.pop();
            planet_labels.pop();
            epicycles.pop();
            links.pop();

            nb_bodies--;
            setupPlanets(nb_bodies);
            clearOrbit();
            if (shouldDrawOrbit) { drawOrbit(0); }
        }
    
        var selectedPlanet;
        var upArrowBox, downArrowBox;

        function selectPlanet() {
            deselectPlanet();
            var ii = +d3.select(this).attr('id');
            if (ii == 0) { return; }
            var planet = heavenly_bodies[ii];
            selectedPlanet = planet;

            for (var i = 0; i < nb_bodies; i++) {
                if (i != ii) {
                    heavenly_bodies[i].attr('opacity', 0.3);
                    if (i != 0) { planet_labels[i - 1].attr('opacity', 0.3); }
                }
            }

            upArrow = svg.append('text')
                .text("⬆︎")
                .style('font-size', planet.attr('r') + 'px')
                .attr('fill','white')
                .attr('text-anchor', 'middle')
                .attr('x', +planet.attr('cx'))
                .attr('y', +planet.attr('cy') - 1.2 * planet.attr('r'))
                .attr('id', planet.attr('id'))
                .attr('transform',T);
            downArrow = svg.append('text')
                .text("⬇")
                .style('font-size', planet.attr('r') + 'px')
                .attr('fill','white')
                .attr('text-anchor', 'middle')
                .attr('x', +planet.attr('cx'))
                .attr('y', +planet.attr('cy') + 2 * planet.attr('r'))
                .attr('id', planet.attr('id'))
                .attr('transform',T);
            upArrow.on('click', increment_frequency);
            downArrow.on('click', decrement_frequency);

        }
    
        function deselectPlanet() {
            if (selectedPlanet != undefined) {
                selectedPlanet.attr('stroke-width', 2);
                for (var i = 0; i < nb_bodies; i++) {
                    heavenly_bodies[i].attr('opacity', 1);
                    if (i < nb_bodies - 1) {
                        planet_labels[i].attr('opacity', 1);
                    }
                }
                selectedPlanet = undefined;
            }
            if (upArrow != undefined) {
                upArrow.remove();
                upArrow = undefined;
            }
            if (downArrow != undefined) {
                downArrow.remove();
                downArrow = undefined;
            }
            if (upArrowBox != undefined) {
                upArrowBox.remove();
                upArrowBox = undefined;
            }
            if (downArrowBox != undefined) {
                downArrowBox.remove();
                downArrowBox = undefined;
            }
        }

        var T = d3.zoomIdentity;
        function zoom() {
            eraseTrace();
            T = d3.event.transform;
            svg.attr("transform", T);
            svg.selectAll('circle').attr("transform", T);
            svg.selectAll('path').attr("transform", T);
            svg.selectAll('g').attr("transform", T);
            svg.selectAll('text').attr("transform", T);
        }

        function zoomTransformX(x) {
            return T.k * x + T.x;
        }

        function zoomTransformY(y) {
            return T.k * y + T.y;
        }
    
        function zoomInverseTransformX(x) {
            return (x - T.x)/T.k;
        }

        function zoomInverseTransformY(y) {
            return (y - T.y)/T.k;
        }

        function drawTargetFigure() {
            var radius = 200;
            var angle = 0;
            var x0 = +heavenly_bodies[0].attr('cx');
            var y0 = +heavenly_bodies[0].attr('cy');
            var path_string = 'M' + (x0 + radius) + ' ' + y0;
            for (var i = 1; i < 6; i++) {
                angle += TAU/6;
                var x = x0 + radius * Math.cos(angle);
                var y = y0 + radius * Math.sin(angle);
                path_string += 'L' + x + ' ' + y;
            }
            path_string += 'Z';
            hexagon = svg.append('path')
                .attr('d', path_string)
                .attr('stroke', 'red')
                .attr('stroke-width', 2)
                .attr('fill', 'none')
        }
        //drawTargetFigure();

    </script>

    <br/>
    <div style='text-align: center;'>
        <img onclick="togglePlay();" id='play_button' style='width: 64px;' src='play.png'></img>
        <img onclick="addPlanet();" id='add_planet_button' style='width: 64px;' src='plus.png'></img>
        <img onclick="removePlanet();" id='remove_planet_button' style='width: 64px;' src='minus.png'></img>
        <img onclick="toggleEpicyclesAndLinks();" id='epicycles_button' style='width: 64px;' src='epicycles-on.png'></img>
        <img onclick="toggleTrace();" id='trace_button' style='width: 64px;' src='show_trace.png'></img>
        <!--<input type="checkbox" name="venus" value="venus"
               value="show_venus" /><label for="venus"></label>-->
    </div>
    <!--<script>


        venusCheckbox = document.querySelector('input[value="venus"]');
        venusCheckbox.onchange = function() {
            if (venusCheckbox.checked) {
                venus_image = d3.selectAll('svg').insert('image','rect')
                    .attr('xlink:href', 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/89/Venus_geocentric_orbit_curve_simplified_Line_%28pentagram%29.svg/602px-Venus_geocentric_orbit_curve_simplified_Line_%28pentagram%29.svg.png')
                    .attr('x', 0)
                    .attr('y', 0)
                    .attr('width', svg_width)
                    .attr('height', svg_height)
                    .attr('opacity', 0.2);
            } else {
                if (venus_image != undefined) {
                    venus_image.remove();
                }
            }
        };
    </script>-->
    


</body>

